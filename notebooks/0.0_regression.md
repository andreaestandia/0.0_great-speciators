0.0\_regression.Rmd
================
Andrea Estandia<br>
26 February, 2021

<br>

``` r
total_world <- read_csv(file.path(data_path, "dfs/worldd.csv"))

total_world_model <- total_world %>% filter(nsubsp/npoly<=1)

total_world_model$altitude_range <- as.numeric(total_world_model$altitude_range)

total_world_model2 <- total_world_model %>% mutate(rel_island_size = log(area)/log(npoly)) %>% mutate(rel_island_size=na_if(rel_island_size, Inf)) %>% distinct(species_name, .keep_all = TRUE) %>% drop_na(rel_island_size,nsubsp,npoly)
stdize = function(x, ...) {(x - min(x, ...)) / (max(x, ...) - min(x, ...))}
total_world_model2 <- total_world_model2 %>%  mutate(rel_island_size=na_if(rel_island_size, -Inf))
total_world_model2$rel_island_size <- stdize(total_world_model2$rel_island_size, na.rm=TRUE)


model_island <- brm(bf(nsubsp|trials(npoly)~rel_island_size),
    family = zero_inflated_binomial(link = "logit"),
    data = total_world_model2)
model_altitude_world <- glm(cbind(nsubsp, npoly)~median+max_dist_poly+area+altitude_range*precip_range*temperature_range, data=total_world_model, family=binomial("logit"), weights=npoly)

model_climatic_world <- glm(cbind(nsubsp,npoly)~median+max_dist_poly+area+altitude_range+precip_range*temperature_range+diet+habitat+ForagingNiche+PC1, data=total_world_model, family=binomial)
plot(conditional_effects(model_island, conditions = data.frame(npoly = 20)),method="predict",points=TRUE)
summary(model_altitude_world)

tree_vig <- read.tree(file.path(data_path, "/raw/bamm/birds_hackett.tre"))
cons_vig = ape::consensus(tree_vig, p=0.5) # To get the majority-rule consensus tree, use p = 0.5

g = total_world_model2 %>% distinct(species_name, .keep_all = TRUE) #%>% drop_na(median,max_dist_poly,area,altitude_range,precip_range,temperature_range,diet,habitat,ForagingNiche,PC1)
#g=g %>% filter(tree_name %in% phylo$tip.label)
g <- g %>%  mutate(failures=npoly-nsubsp)
species_names <- g %>% dplyr::select(tree_name) %>% filter(tree_name %in% tree_vig$tip.label)

phylo <- keep.tip(tree_vig,species_names$tree_name)

cons_vig2 = compute.brlen(cons_vig) # computes branch lengths, needed for next steps
vig_phylo <- vcv.phylo(cons_vig2, cor = T)


island <- pglmm(cbind(nsubsp,failures)~hwi+(1|tree_name__), data=g, cov_ranef = list(tree_name = cons_vig2), family="binomial")
```
