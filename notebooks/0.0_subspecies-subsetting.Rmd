---
title: "0.0_subspecies-subsetting.Rmd"
author: "Andrea Estandia<br>"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  github_document:
  toc: true
toc_depth: 4
editor_options:
  chunk_output_type: console
---
  <br>
  
```{r setup, echo=FALSE}
# Knitr settings: 
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
options(scipen = 999)
```

```{r, echo=FALSE}
source("./src/0.0_great-speciators_source.R")
```

## Open Clements file, count number of subspecies per taxonomic group (genus/species)
```{r}
checklist <- read_csv(file.path(data_path,"Clements-Checklist-v2019-August-2019.csv")) %>%  
  clean_names()  %>% 
  separate(scientific_name, c("genus", "species", "subspecies")) 

gs_candidates <- checklist %>% 
  unite(species_name, c("genus", "species"), sep=" ") %>% 
  filter(category!="group (polytipic)") %>% 
  group_by(species_name,category) %>% 
  filter(category == "subspecies") %>% 
  mutate(occurrences = n()) 

melanesia <- read_csv(file.path(data_path,"nsubsp_melanesia.csv")) %>% 
  filter(northern_melanesia == 1) %>% 
  filter(category!="group (polytipic)") %>% 
  group_by(species_name,category) %>% 
  filter(category == "subspecies") %>% 
  mutate(occurrences = n()) %>% 
  mutate(distr_index_final =  occurrences*log10(distr_index)) %>% 
  arrange(desc(distr_index_final)) 

australasia <- read_csv(file.path(data_path,"nsubsp_australasia.csv")) %>% 
  filter(australasia == 1) %>% 
  filter(category!="group (polytipic)") %>% 
  group_by(species_name,category) %>% 
  filter(category == "subspecies") %>% 
  mutate(occurrences = n()) %>% 
  mutate(distr_index_final = occurrences*log10(distr_index)) %>% 
  arrange(desc(distr_index_final))

tip_rates <- read_csv(file.path(data_path,"tiprates.csv")) %>% separate(species_name, c("genus", "species")) %>% unite(species_name, c("genus", "species"), sep=" ") 
```

## Open trait datasets and merge them with the checklist file.
```{r}
hwi <- read_csv(file.path(data_path,"Dataset HWI 2020-04-10.csv"))
hwi <- clean_names(hwi) 

traits1 <- read_csv(file.path(data_path,"Bird_Database_Ernest.csv")) %>% 
  clean_names() %>% 
  unite(species_name, c("genus", "species"), sep=" ")
traits2 <- read_csv(file.path(data_path,"TetraDENSITY_v.1.csv")) %>% 
  clean_names() %>% 
  unite(species_name, c("genus", "species"), sep=" ") %>% 
  filter(class=="Aves")

world <- read_csv(file.path(data_path, "distr_index_total.csv")) 

dataset_world <- left_join(gs_candidates, hwi, by = "species_name") %>% 
  ungroup() %>% 
  left_join(traits1, by = "species_name") %>% 
  left_join(traits2, by = "species_name") %>%
  left_join(world, by = "species_name") %>%
  left_join(tip_rates, by="species_name") %>% 
  mutate(distr_index_final = occurrences*distr_index) %>% 
  drop_na(distr_index_final) %>% 
  clean_names() %>%
  distinct(sort_v2019, .keep_all = TRUE) %>% 
  filter(!(order_x %in% c("Procellariiformes", "Suliformes", "Charadriiformes"))) 
    
dataset_australasia <- left_join(gs_candidates, hwi, by = "species_name") %>% 
  ungroup() %>% 
  left_join(traits1, by = "species_name") %>% 
  left_join(traits2, by = "species_name") %>%
  left_join(australasia, by = "species_name") %>%
  left_join(tip_rates, by="species_name") %>% 
  drop_na(distr_index_final) %>% 
  clean_names() %>% 
  distinct(sort_v2019, .keep_all = TRUE) %>% 
  filter(!(order_x %in% c("Procellariiformes", "Suliformes", "Charadriiformes"))) 

dataset_melanesia <- left_join(gs_candidates, hwi, by = "species_name") %>% 
  ungroup() %>% 
  left_join(traits1, by = "species_name") %>% 
  left_join(traits2, by = "species_name") %>%
  left_join(melanesia, by = "species_name") %>%
  left_join(tip_rates, by="species_name") %>% 
  drop_na(distr_index_final) %>% 
  clean_names() %>% 
  distinct(sort_v2019, .keep_all = TRUE) %>% 
  filter(!(order_x %in% c("Procellariiformes", "Suliformes", "Charadriiformes"))) 
```

## Create plots 
```{r}
plot_australasia <- dataset_melanesia %>%
  filter(distr_index_final!="NA") %>% 
  arrange(desc(distr_index_final)) %>% 
  #filter(occurrences_y > 2) %>%
  #filter(species_name!="Alcedo atthis") %>% 
  #top_n(900, distr_index_final) %>% 
  ggplot(aes(
    x = fct_reorder(species_name, distr_index_final),
    y = distr_index_final,
    #size=occurrences_y,
    #color=distr_index
  )) +
  geom_point()+
  scale_colour_viridis()+
  #geom_jitter(alpha = 0.2) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank(),
    #axis.text.x = element_text(size= text_size, angle = 45, vjust = 0.9,hjust=1, face= "bold"),
    axis.ticks.y = element_blank()
  ) + 
  guides(colour = guide_legend(title="Area (km2)", size=text_size), size = guide_legend(title="Number of subspecies",  size=text_size)) + labs(y = "Great speciator index\n", x= "\nSpecies", size= text_size, title = "Northern Melanesia", face= "bold")


plot1 <- plot_world+ plot_australasia+plot_melanesia+plot_layout(ncol=1)+plot_annotation(tag_levels = 'A')

ggsave(
  plot = plot1,
  filename = "plot.pdf",
  path = figures_path,
  device = "pdf",
  scale=1,
  width = 24,
  height = 45,
  dpi = 400,
  units = "cm"
)
```

checklist_spcomplex <- read_csv(file.path(data_path,"Clements-Checklist-v2019-August-2019.csv")) %>%  
  clean_names() %>% 
  mutate(sp_complex = grepl("\\[.+?\\]", scientific_name)) 
